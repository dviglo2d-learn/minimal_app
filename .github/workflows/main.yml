# Copyright (c) the Dviglo project
# Copyright (c) 2008-2023 the Urho3D project
# License: MIT

name: CI/CD

on:
  push:
  pull_request:

jobs:
  Windows:
    # Job –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ —Å –Ω–æ–≤–µ–π—à–µ–π –≤–µ—Ä—Å–∏–µ–π Windows
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
    # https://github.com/actions/runner-images
    runs-on: windows-latest

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞—Ç—Ä–∏—Ü—É –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏ —Ä–∞–∑–Ω—ã—Ö –±–∏–ª–¥–æ–≤
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategy
    strategy:
      fail-fast: false
      matrix:
        COMPILER: [vs, mingw]
        BUILD_TYPE: [debug, release]

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è job
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idname
    name: üî≤-${{ matrix.COMPILER }}-${{ matrix.BUILD_TYPE }}

    steps:
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º MSYS2 –≤–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ MinGW
      # https://github.com/urho3d/urho3D/issues/2887
    - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MinGW
      if: matrix.COMPILER == 'mingw'
      # https://www.msys2.org/docs/ci/
      # https://github.com/msys2/setup-msys2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: mingw-w64-x86_64-toolchain

    - name: –î–æ–±–∞–≤–ª—è–µ–º –≤ PATH –ø—É—Ç—å –∫ MinGW
      if: matrix.COMPILER == 'mingw'
      shell: bash
      # https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#adding-a-system-path
      run: echo "${RUNNER_TEMP}/msys64/mingw64/bin" >> $GITHUB_PATH

    - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å–æ—Ñ—Ç
      shell: bash
      run: |
        choco install --no-progress graphviz.portable

        # choco –∫–∞—á–∞–µ—Ç Doxygen —á–µ—Ä–µ–∑ —Ä–∞–∑. –ö–∞—á–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–±–æ—Ä–∫—É
        mkdir $GITHUB_WORKSPACE/programs
        cd $GITHUB_WORKSPACE/programs
        curl -Lso tmp.zip https://github.com/dviglo-tools/doxygen-builder/raw/main/doxygen_win64.zip && unzip tmp.zip && rm tmp.zip
        echo "$GITHUB_WORKSPACE/programs" >> $GITHUB_PATH
        echo "–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ Doxygen —Å–∫–∞—á–∞–Ω–∞ –≤ $GITHUB_WORKSPACE/programs"

    - name: –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      # https://github.com/actions/checkout
      uses: actions/checkout@v4
      with:
        path: repo # –ü–∞–ø–∫–∞, –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        submodules: recursive # –î–≤–∏–∂–æ–∫ —Ç–æ–∂–µ –∫–∞—á–∞–µ–º

    - name: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç—ã
      shell: bash
      run: |
        ARGS=(repo -B build) # –ú–∞—Å—Å–∏–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

        if [ "${{ matrix.COMPILER }}" == "vs" ]
        then
          ARGS+=(-G "Visual Studio 17 2022")
        else
          ARGS+=(-G "MinGW Makefiles")
          # –î–ª—è MinGW —Ç–∏–ø —Å–±–æ—Ä–∫–∏ –∑–∞–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
          ARGS+=(-D CMAKE_BUILD_TYPE=${{ matrix.BUILD_TYPE }})
        fi

        ARGS+=(-D DV_CTEST=1)

        cmake "${ARGS[@]}"

    - name: –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º
      shell: bash
      run: |
        ARGS=(--build build) # –ú–∞—Å—Å–∏–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

        if [ "${{ matrix.COMPILER }}" == "vs" ]
        then
          # –î–ª—è Visual Studio —Ç–∏–ø —Å–±–æ—Ä–∫–∏ –∑–∞–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
          ARGS+=(--config ${{ matrix.BUILD_TYPE }})
        fi

        cmake "${ARGS[@]}"

      # –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –ì–∏—Ç–•–∞–±–∞ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å Direct3D-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è,
      # –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å OpenGL-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º
      # –ø—Ä–µ–¥–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Mesa 3D for Windows
    - name: –ö–∞—á–∞–µ–º Mesa 3D
      shell: bash
      run: |
        # –ö–∞—á–∞–µ–º –∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º Mesa 3D
        # https://curl.se/docs/manpage.html
        curl.exe --location --output mesa.7z --url https://github.com/pal1000/mesa-dist-win/releases/download/22.2.3/mesa3d-22.2.3-release-msvc.7z
        7z x mesa.7z -omesa
        rm mesa.7z

        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –Ω—É–∂–Ω—ã–µ dll –≤ –ø–∞–ø–∫—É result
        #mv mesa/x64/dxil.dll build/result # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —ç–º—É–ª—è—Ü–∏–∏ —á–µ—Ä–µ–∑ DirectX
        mv mesa/x64/libgallium_wgl.dll build/result
        mv mesa/x64/libglapi.dll build/result
        mv mesa/x64/opengl32.dll build/result

    - name: CTest
      shell: bash {0} # –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫
      run: |
        ARGS=(--test-dir build --timeout 60) # –ú–∞—Å—Å–∏–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

        if [ "${{ matrix.COMPILER }}" == "vs" ]
        then
          # –î–ª—è Visual Studio –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∏–ø —Å–±–æ—Ä–∫–∏ (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é)
          ARGS+=(-C ${{ matrix.BUILD_TYPE }})
        fi

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Mesa (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º DirectX –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏).
        # –ë–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç –ø—Ä–∏–º–µ—Ä–∞ pbr_materials.
        # https://docs.mesa3d.org/envvars.html
        export LIBGL_ALWAYS_SOFTWARE=true

        ctest "${ARGS[@]}"
        EXIT_CODE=$? # –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–º–∞–Ω–¥—ã

        if (( $EXIT_CODE != 0 )) 
        then
          echo "$(cat D:/a/minimal_app/minimal_app/build/Testing/Temporary/LastTest.log)" # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–æ–≥–∞
          exit $EXIT_CODE
        fi

  Linux_Native:
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        COMPILER:
        - {
            ID: gcc,
            #C: gcc,
            #CXX: g++,
            C: gcc-13, # –ò—Å–ø–æ–ª—å–∑—É–µ–º GCC 13, —Ç–∞–∫ –∫–∞–∫ 12 –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç std::format
            CXX: g++-13,
          }
        - {
            ID: clang,
            #C: clang,
            #CXX: clang++,
            C: clang-16,
            CXX: clang++-16,
          }
        BUILD_TYPE:
        - {
            ID: dbg,
            VALUE: Debug,
          }
        - {
            ID: rel,
            VALUE: Release,
          }

    name: üêß-${{ matrix.COMPILER.ID }}-${{ matrix.BUILD_TYPE.ID }}

    steps:
    - name: –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      uses: actions/checkout@v4
      with:
        path: repo # –ü–∞–ø–∫–∞, –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        submodules: recursive # –î–≤–∏–∂–æ–∫ —Ç–æ–∂–µ –∫–∞—á–∞–µ–º

    - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        sudo apt update
        # –ë–µ–∑ libxrandr-dev –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è —É–∑–Ω–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        sudo apt install libgl1-mesa-dev libxrandr-dev

        # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Ubuntu —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Å—Ç–∞—Ä–µ–≤—à—É—é –≤–µ—Ä—Å–∏—é Doxygen 1.9.1. –ö–∞—á–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–±–æ—Ä–∫—É
        mkdir $HOME/programs
        cd $HOME/programs
        wget -q -O tmp.zip https://github.com/dviglo-tools/doxygen-builder/raw/main/doxygen_linux64.zip && unzip tmp.zip && rm tmp.zip
        echo "$HOME/programs" >> $GITHUB_PATH

    - name: –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º
      run: |
        #set -x # Echo commands
        echo "Current dir: $PWD"

        cmake repo -B build -G "Unix Makefiles" \
          -D CMAKE_C_COMPILER=${{ matrix.COMPILER.C }} -D CMAKE_CXX_COMPILER=${{ matrix.COMPILER.CXX }} \
          -D CMAKE_BUILD_TYPE=${{ matrix.BUILD_TYPE.VALUE }} \
          -D DV_CTEST=1 

        cmake --build build

    - name: CTest
      shell: bash {0} # –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫
      run: |
        xvfb-run ctest --test-dir build --timeout 60
        EXIT_CODE=$? # Exit code of the previous command

        if (( $EXIT_CODE != 0 )) 
        then
          echo "$(cat /home/runner/work/minimal_app/minimal_app/build/Testing/Temporary/LastTest.log)"
          exit $EXIT_CODE
        fi
